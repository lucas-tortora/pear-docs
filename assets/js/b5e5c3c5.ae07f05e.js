"use strict";(globalThis.webpackChunkpear_docs_docusarus=globalThis.webpackChunkpear_docs_docusarus||[]).push([[4360],{5951:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>d,contentTitle:()=>s,default:()=>l,frontMatter:()=>a,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"how-to/replicate-and-persist-data/create-a-full-peer-to-peer-filesystem-with-hyperdrive","title":"How to create a full peer-to-peer filesystem with Hyperdrive","description":"Hyperdrive is a secure, real-time distributed file system designed for easy peer-to-peer file sharing. In the same way that a Hyperbee is just a wrapper around a Hypercore, a Hyperdrive is a wrapper around two Hypercores: one is a Hyperbee index for storing file metadata, and the other is used to store file contents.","source":"@site/docs/how-to/replicate-and-persist-data/create-a-full-peer-to-peer-filesystem-with-hyperdrive.md","sourceDirName":"how-to/replicate-and-persist-data","slug":"/how-to/replicate-and-persist-data/create-a-full-peer-to-peer-filesystem-with-hyperdrive","permalink":"/pear-docs/how-to/replicate-and-persist-data/create-a-full-peer-to-peer-filesystem-with-hyperdrive","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/how-to/replicate-and-persist-data/create-a-full-peer-to-peer-filesystem-with-hyperdrive.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"How to share Append-Only Databases with Hyperbee","permalink":"/pear-docs/how-to/replicate-and-persist-data/share-append-only-databases-with-hyperbee"},"next":{"title":"Making a Bare Mobile Application","permalink":"/pear-docs/how-to/create-mobile-apps/create-a-bare-mobile-app"}}');var i=n(4848),o=n(8453);const a={},s="How to create a full peer-to-peer filesystem with Hyperdrive",d={},c=[];function p(e){const r={a:"a",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"how-to-create-a-full-peer-to-peer-filesystem-with-hyperdrive",children:"How to create a full peer-to-peer filesystem with Hyperdrive"})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.a,{href:"../building-blocks/hyperdrive.md",children:(0,i.jsx)(r.code,{children:"Hyperdrive"})})," is a secure, real-time distributed file system designed for easy peer-to-peer file sharing. In the same way that a Hyperbee is just a wrapper around a Hypercore, a Hyperdrive is a wrapper around two Hypercores: one is a Hyperbee index for storing file metadata, and the other is used to store file contents."]}),"\n",(0,i.jsxs)(r.p,{children:["This How-to consists of three applications: ",(0,i.jsx)(r.code,{children:"drive-writer-app"}),", ",(0,i.jsx)(r.code,{children:"drive-reader-app"})," and ",(0,i.jsx)(r.code,{children:"drive-bee-reader-app"}),"."]}),"\n",(0,i.jsxs)(r.p,{children:["Now let's mirror a local directory into a Hyperdrive, replicate it with a reader peer, who then mirrors it into their own local copy. When the writer modifies its drive, by adding, removing, or changing files, the reader's local copy will be updated to reflect that. To do this, we'll use two additional tools: ",(0,i.jsx)(r.a,{href:"../helpers/mirrordrive.md",children:(0,i.jsx)(r.code,{children:"MirrorDrive"})})," and ",(0,i.jsx)(r.a,{href:"../helpers/localdrive.md",children:(0,i.jsx)(r.code,{children:"LocalDrive"})}),", which handle all interactions between Hyperdrives and the local filesystem."]}),"\n",(0,i.jsxs)(r.p,{children:["Start by creating the ",(0,i.jsx)(r.code,{children:"drive-writer-app"})," project with these commands:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"mkdir drive-writer-app\ncd drive-writer-app\npear init -y -t terminal\nnpm install corestore localdrive hyperswarm hyperdrive debounceify b4a pear-stdio\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Alter ",(0,i.jsx)(r.code,{children:"driver-writer-app/index.js"})," to the following:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-javascript",children:"import Hyperswarm from 'hyperswarm'\nimport Hyperdrive from 'hyperdrive'\nimport Localdrive from 'localdrive'\nimport Corestore from 'corestore'\nimport debounce from 'debounceify'\nimport b4a from 'b4a'\nimport stdio from 'pear-stdio'\n\n// create a Corestore instance \nconst store = new Corestore(Pear.config.storage)\nconst swarm = new Hyperswarm()\nPear.teardown(() => swarm.destroy())\n\n// replication of the corestore instance on connection with other peers\nswarm.on('connection', conn => store.replicate(conn))\n\n// A local drive provides a Hyperdrive interface to a local directory\nconst local = new Localdrive('./writer-dir')\n\n// A Hyperdrive takes a Corestore because it needs to create many cores\n// One for a file metadata Hyperbee, and one for a content Hypercore\nconst drive = new Hyperdrive(store)\n\n// wait till the properties of the hyperdrive instance are initialized\nawait drive.ready()\n\n// Import changes from the local drive into the Hyperdrive\nconst mirror = debounce(mirrorDrive)\n\nconst discovery = swarm.join(drive.discoveryKey)\nawait discovery.flushed()\n\nconsole.log('drive key:', b4a.toString(drive.key, 'hex'))\n\n// start the mirroring process (i.e copying) of content from writer-dir to the drive\n// whenever something is entered (other than '/n' or Enter )in the command-line\nstdio.in.setEncoding('utf-8')\nstdio.in.on('data', (data) => {\n  if (!data.match('\\n')) return\n  mirror()\n})\n\n// this function copies the contents from writer-dir directory to the drive\nasync function mirrorDrive () {\n  console.log('started mirroring changes from \\'./writer-dir\\' into the drive...')\n  const mirror = local.mirror(drive)\n  await mirror.done()\n  console.log('finished mirroring:', mirror.count)\n}\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Open the ",(0,i.jsx)(r.code,{children:"drive-writer-app"})," with:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"pear run --dev .\n"})}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"drive-writer-app"})," creates a ",(0,i.jsx)(r.code,{children:"LocalDrive"})," instance for a local directory and then mirrors the ",(0,i.jsx)(r.code,{children:"LocalDrive"})," into the Hyperdrive instance."]}),"\n",(0,i.jsx)(r.p,{children:"The store used to create the Hyperdrive instance is replicated using Hyperswarm to make the data of Hyperdrive accessible to other peers."}),"\n",(0,i.jsxs)(r.p,{children:["It outputs a key which will be passed to ",(0,i.jsx)(r.code,{children:"drive-reader-app"})," upon execution."]}),"\n",(0,i.jsxs)(r.p,{children:["Leave the ",(0,i.jsx)(r.code,{children:"driver-writer-app"})," running and in a new terminal create the ",(0,i.jsx)(r.code,{children:"drive-reader-app"})," project with these commands:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"mkdir drive-reader-app\ncd drive-reader-app\npear init -y -t terminal\nnpm install corestore localdrive hyperswarm hyperdrive debounceify b4a\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Adjust the ",(0,i.jsx)(r.code,{children:"drive-reader-app/index.js"})," file to:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-javascript",children:"import Hyperswarm from 'hyperswarm'\nimport Hyperdrive from 'hyperdrive'\nimport Localdrive from 'localdrive'\nimport Corestore from 'corestore'\nimport debounce from 'debounceify'\nimport b4a from 'b4a'\n\nconst key = Pear.config.args[0]\n\nif (!key) throw new Error('provide a key')\n\n// create a Corestore instance\nconst store = new Corestore(Pear.config.storage)\n\nconst swarm = new Hyperswarm()\nPear.teardown(() => swarm.destroy())\n\n// replication of store on connection with other peers\nswarm.on('connection', conn => store.replicate(conn))\n\n// create a local copy of the remote drive\nconst local = new Localdrive('./reader-dir')\n\n// create a hyperdrive using the public key passed as a command-line argument\nconst drive = new Hyperdrive(store, b4a.from(key, 'hex'))\n\n// wait till all the properties of the drive are initialized\nawait drive.ready()\n\nconst mirror = debounce(mirrorDrive)\n\n// call the mirror function whenever content gets appended \n// to the Hypercore instance of the hyperdrive\ndrive.core.on('append', mirror)\n\n// join a topic\nswarm.join(drive.discoveryKey, { client: true, server: false })\n\n// start the mirroring process (i.e copying the contents from remote drive to local dir)\nmirror()\n\nasync function mirrorDrive () {\n  console.log('started mirroring remote drive into \\'./reader-dir\\'...')\n  const mirror = drive.mirror(local)\n  await mirror.done()\n  console.log('finished mirroring:', mirror.count)\n}\n"})}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"drive-reader-app"})," creates a ",(0,i.jsx)(r.code,{children:"LocalDrive"})," instance for a local directory and then mirrors the contents of the local Hyperdrive instance into the ",(0,i.jsx)(r.code,{children:"LocalDrive"})," instance (which will write the contents to the local directory)."]}),"\n",(0,i.jsxs)(r.p,{children:["Run the ",(0,i.jsx)(r.code,{children:"drive-reader-app"})," with ",(0,i.jsx)(r.code,{children:"pear run --dev ."}),", passing the key that the ",(0,i.jsx)(r.code,{children:"drive-writer-app"})," already output:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"pear run --dev . <SUPPLY_KEY_HERE>\n"})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"LocalDrive"})," does not create the directory passed to it until something has been written, so create the ",(0,i.jsx)(r.code,{children:"drive-writer-app/writer-dir"})," (",(0,i.jsx)(r.code,{children:"mkdir writer-dir"}),") and then add/remove/modify files inside ",(0,i.jsx)(r.code,{children:"drive-writer-app/writer-dir"})," then press ",(0,i.jsx)(r.code,{children:"Enter"})," in the writer's terminal (to import the local changes into the writer's drive). Observe that all new changes mirror into ",(0,i.jsx)(r.code,{children:"reader-app/reader-dir"}),"."]}),"\n",(0,i.jsxs)(r.p,{children:["Just as a Hyperbee is ",(0,i.jsx)(r.strong,{children:"just"})," a Hypercore, a Hyperdrive is ",(0,i.jsx)(r.strong,{children:"just"})," a Hyperbee - which is ",(0,i.jsx)(r.strong,{children:"just"})," a Hypercore."]}),"\n",(0,i.jsxs)(r.p,{children:["In a new terminal, create the ",(0,i.jsx)(r.code,{children:"drive-bee-reader-app"})," project with these commands:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"mkdir drive-bee-reader-app\ncd drive-bee-reader-app\npear init -y -t terminal\nnpm install corestore hyperswarm hyperdrive hyperbee b4a\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Adjust the ",(0,i.jsx)(r.code,{children:"drive-bee-reader-app/index.js"})," file to:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-javascript",children:"import Hyperswarm from 'hyperswarm'\nimport Corestore from 'corestore'\nimport Hyperbee from 'hyperbee'\nimport b4a from 'b4a'\n\nconst key = Pear.config.args[0]\nif (!key) throw new Error('provide a key')\n\n// create a Corestore instance \nconst store = new Corestore(Pear.config.storage)\n\nconst swarm = new Hyperswarm()\nPear.teardown(() => swarm.destroy())\n\n// replicate corestore instance on connection with other peers\nswarm.on('connection', conn => store.replicate(conn))\n\n// create/get the hypercore instance using the public key supplied as command-line arg\nconst core = store.get({ key: b4a.from(key, 'hex') })\n\n// create a hyperbee instance using the hypercore instance\nconst bee = new Hyperbee(core, {\n  keyEncoding: 'utf-8',\n  valueEncoding: 'json'\n})\n\n// wait till the properties of the hypercore instance are initialized\nawait core.ready()\n\nswarm.join(core.discoveryKey)\nawait swarm.flush()\n\n// execute the listBee function whenever the data is appended to the underlying hypercore\ncore.on('append', listBee)\n\nlistBee()\n\n// listBee function will list the key-value pairs present in the hyperbee instance\nasync function listBee () {\n  console.log('\\n***************')\n  console.log('hyperbee contents are now:')\n  for await (const node of bee.createReadStream()) {\n    console.log('  ', node.key, '->', node.value)\n  }\n}\n"})}),"\n",(0,i.jsx)(r.p,{children:"Now the Hyperdrive can be inspected as though it were a Hyperbee, and log out some file metadata."}),"\n",(0,i.jsxs)(r.p,{children:["Execute the ",(0,i.jsx)(r.code,{children:"drive-bee-reader-app"})," with ",(0,i.jsx)(r.code,{children:"pear run --dev ."}),", passing it the key output by the ",(0,i.jsx)(r.code,{children:"driver-writer-app"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"pear run --dev . <SUPPLY_KEY_HERE>\n"})}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"drive-bee-reader-app"})," creates a Hyperbee instance using the Hypercore instance created with the copied public key. Every time the Hyperbee is updated (an ",(0,i.jsx)(r.code,{children:"append"})," event is emitted on the underlying Hypercore), all file metadata nodes will be logged out."]}),"\n",(0,i.jsxs)(r.p,{children:["Try adding or removing a few files from the writer's data directory, then pressing ",(0,i.jsx)(r.code,{children:"Enter"})," in the writer's terminal to mirror the changes."]})]})}function l(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>a,x:()=>s});var t=n(6540);const i={},o=t.createContext(i);function a(e){const r=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function s(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(o.Provider,{value:r},e.children)}}}]);